name: Get Python Versions

on:
  workflow_call:
    inputs:
      python_versions:
        description: 'Comma-separated list of Python versions. If not provided, versions will be read from pyproject.toml'
        default: ""
        required: false
        type: string
    outputs:
      python_versions:
        description: 'Comma-separated list of Python versions'
        value: ${{ jobs.get-python-versions.outputs.python_versions }}
      python_versions_json:
        description: 'JSON array of Python versions as strings'
        value: ${{ jobs.get-python-versions.outputs.python_versions_json }}

jobs:
  get-python-versions:
    runs-on: ubuntu-latest
    outputs:
      python_versions: ${{ steps.set-versions.outputs.python_versions }}
      python_versions_json: ${{ steps.format-json.outputs.python_versions_json }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Extract Python versions from pyproject.toml
        id: set-versions
        run: |
          if [ -n "${{ inputs.python_versions }}" ]; then
            # Use user-provided versions if specified
            VERSIONS="${{ inputs.python_versions }}"
            echo "Using user-provided Python versions: $VERSIONS"
          else
            # Extract versions from pyproject.toml classifiers
            if [ -f "pyproject.toml" ]; then
              # Extract Python version classifiers (e.g., "Programming Language :: Python :: 3.12")
              # Using sed to handle multi-digit minor versions like 3.10, 3.11, etc.
              VERSIONS=$(grep "Programming Language :: Python :: 3\." pyproject.toml | sed -E 's/.*Python :: (3\.[0-9]+).*/\1/' | sort -V | tr '\n' ',' | sed 's/,$//')

              if [ -z "$VERSIONS" ]; then
                echo "Warning: No Python version classifiers found in pyproject.toml"
                # Fallback to default versions
                VERSIONS="3.12,3.13,3.14"
                echo "Using fallback versions: $VERSIONS"
              else
                echo "Extracted Python versions from pyproject.toml: $VERSIONS"
              fi
            else
              echo "Warning: pyproject.toml not found"
              # Fallback to default versions
              VERSIONS="3.12,3.13,3.14"
              echo "Using fallback versions: $VERSIONS"
            fi
          fi
          echo "python_versions=$VERSIONS" >> $GITHUB_OUTPUT

      - name: Format versions as JSON array
        id: format-json
        run: |
          VERSIONS="${{ steps.set-versions.outputs.python_versions }}"
          # Convert "3.9, 3.10, 3.11" to ["3.9", "3.10", "3.11"]
          JSON_ARRAY=$(echo "$VERSIONS" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/' | sed 's/ //g')
          echo "Formatted JSON array: $JSON_ARRAY"
          echo "python_versions_json=$JSON_ARRAY" >> $GITHUB_OUTPUT
